<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D UMAP</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/scatter-gl@0.0.13/lib/scatter-gl.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
    }

    #container {
      width: 100vw;
      height: 100vh;
    }

    #controls {
      position: fixed;
      top: 0;
      left: 0;
      padding: 10px;
    }

    #point-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.25);
      border-radius: 5px;
      max-width: 400px;
      max-height: 300px;
    }

    #title {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 5px;
      font-size: 24px;
      font-weight: bold;
    }

    .mdl-js-radio {
      margin-left: 10px;
    }

    .button {
      margin-top: 18px;
    }

    #color-legend {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 5px;
      display: none;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="title">3D UMAP</div>
  <div id="controls">
    <div class="interactions control">
      <h5>Controls</h5>
      <label class="mdl-radio mdl-js-radio" for="pan-interaction">
        <input type="radio" class="mdl-radio__button" id="pan-interaction" name="interactions" value="pan" checked>
        <span class="mdl-radio__label">Pan</span>
      </label>
      <label class="mdl-radio mdl-js-radio" for="select-interaction">
        <input type="radio" class="mdl-radio__button" id="select-interaction" name="interactions" value="select">
        <span class="mdl-radio__label">Select</span>
      </label>
    </div>
    <div class="button control">
      <button id="toggle-orbit" class="mdl-button mdl-js-button mdl-button--raised">
        Toggle Orbit
      </button>
    </div>
    <hr>
    <div class="color control">
      <h5>Color by</h5>
      <select id="color-select" class="mdl-textfield__input">
        <option value="-1">Default</option>
        <!-- Other options will be dynamically added here -->
      </select>
    </div>
    <div id="point-info">
      <pre id="messages"></pre>
    </div>
  </div>
  <div id="color-legend"></div>
  <script>
    // Embedded CSV data
    const dataCSV = `ID,x,y,z
TCGA-EA-A3HU,14.542328,16.92496,12.529218
TCGA-DS-A1OB,14.419792,17.176184,12.596419
TCGA-C5-A7UH,12.904934,18.01291,13.106919
TCGA-HM-A6W2,14.225602,14.151255,8.946829
TCGA-VS-A8EK,13.383875,17.939196,12.756024
TCGA-FU-A3EO,13.204303,15.299643,12.427224
TCGA-LP-A5U3,14.3241,17.634611,12.790635
TCGA-ZJ-AAXF,13.477513,16.291073,13.214647
TCGA-DR-A0ZL,13.111851,17.297869,12.227512
TCGA-VS-A958,14.288536,17.334589,12.529655
TCGA-EK-A3GM,14.041367,13.895387,7.430364
TCGA-C5-A1MF,14.725521,17.497427,10.861256
TCGA-JW-A5VH,13.971221,14.733382,9.05712
TCGA-MU-A5YI,13.173441,15.637322,12.831524
TCGA-ZJ-AAXI,13.66884,17.466185,12.383347
TCGA-C5-A1BI,13.827896,17.4951,13.673105
TCGA-C5-A1BJ,13.180501,17.26056,13.106005
TCGA-EA-A3Y4,13.479386,18.54792,9.822015
TCGA-C5-A1BK,14.59835,17.57064,12.159522
TCGA-EK-A2PM,12.202377,17.261488,12.925939
TCGA-ZJ-AAXA,13.887511,18.016956,13.595509
TCGA-ZJ-AAX8,13.401593,16.544163,13.752521
TCGA-VS-A9U5,13.724303,16.956312,12.118875
TCGA-2W-A8YY,14.206643,14.502144,8.832555
TCGA-MU-A8JM,13.664435,16.838497,13.477771
TCGA-VS-A8QF,13.8253975,17.959812,13.139132
TCGA-EK-A2R9,13.267808,15.56017,12.558795
TCGA-C5-A1BN,12.74708,18.467056,11.473073
TCGA-LP-A4AW,13.135333,15.677669,12.902821
TCGA-VS-A9UC,14.035747,16.389114,13.095924
TCGA-EA-A6QX,13.859831,16.534472,12.644359
TCGA-C5-A2LS,14.573467,13.660313,7.097644
TCGA-HM-A3JJ,13.1839695,15.329563,12.40403
TCGA-C5-A1MJ,14.122423,14.278197,8.550688
TCGA-C5-A1MI,14.047352,15.082838,9.464501
TCGA-C5-A1MH,14.59964,17.554712,12.858623
TCGA-C5-A2LV,12.927634,18.876919,10.112333
TCGA-EK-A2R8,13.242386,18.271196,9.645834
TCGA-VS-A9UU,13.331112,18.340652,12.676757
TCGA-C5-A1M8,13.619385,18.383804,13.57043
TCGA-FU-A3HY,12.668737,18.186516,12.028899
TCGA-C5-A1ML,13.12185,16.826155,13.124869
TCGA-C5-A2LZ,13.800832,17.759197,12.730745
TCGA-C5-A7CH,12.770347,18.595133,12.285517
TCGA-IR-A3LF,14.146835,13.5843315,7.656623
TCGA-C5-A7UC,12.774716,18.697971,10.59313
TCGA-VS-A8Q8,13.947252,17.37685,13.16219
TCGA-4J-AA1J,12.987131,16.521828,12.829239
TCGA-C5-A7CG,14.669492,16.83064,11.7033415
TCGA-VS-A9UB,12.947299,18.50836,10.127862
TCGA-DS-A1OA,13.791621,16.721594,12.904709
TCGA-VS-A9UQ,14.333985,13.491824,7.3927617
TCGA-VS-A950,12.86608,18.11103,12.970362
TCGA-C5-A902,13.821905,17.659029,11.277983
TCGA-FU-A23L,13.762331,16.481556,12.206717
TCGA-EA-A3HS,13.382046,17.834599,13.204643
TCGA-C5-A1ME,14.150101,13.814506,7.879575
TCGA-C5-A1MQ,13.770471,18.49347,10.139595
TCGA-EK-A2IP,12.806015,18.485334,12.290995
TCGA-VS-A9UY,14.325675,17.820345,12.924977
TCGA-DG-A2KJ,14.891411,17.500011,10.5380125
TCGA-VS-A9V0,14.187668,14.265899,8.401579
TCGA-C5-A3HF,13.990924,13.954581,7.8978343
TCGA-DS-A0VL,13.37167,17.168575,12.429054
TCGA-C5-A905,13.26387,17.599958,12.4644785
TCGA-C5-A3HD,12.901502,18.363462,11.288553
TCGA-XS-A8TJ,13.2979765,16.859543,12.458374
TCGA-C5-A7X3,13.24521,18.51035,9.780181
TCGA-EK-A2RL,14.315803,13.779953,7.109124
TCGA-DS-A5RQ,13.701706,17.12723,12.976814
TCGA-EK-A2RO,14.031306,18.030277,11.903973
TCGA-VS-A8QC,12.907473,17.935204,13.241689
TCGA-C5-A7CO,13.603416,17.307573,12.21952
TCGA-EA-A3QD,14.642499,16.944647,11.343832
TCGA-C5-A1M9,14.7177,13.730375,7.905725
TCGA-JW-A5VG,12.841695,18.708233,10.25582
TCGA-EK-A2RK,13.827213,17.12708,12.163089
TCGA-VS-A8EL,14.8013935,17.913477,12.795245
TCGA-FU-A2QG,12.881735,17.969955,12.260324
TCGA-C5-A1MN,12.663298,18.494736,11.902923
TCGA-Q1-A73P,14.202663,13.87356,7.5308423
TCGA-VS-A9V2,14.04106,17.441807,12.231846
TCGA-JW-AAVH,13.11339,17.285326,12.393356
TCGA-C5-A907,13.416772,18.097328,9.466644
TCGA-LP-A4AX,13.114719,18.267155,10.024973
TCGA-ZJ-AAXT,12.96205,18.374115,13.157449
TCGA-EA-A1QT,13.259992,17.471231,12.513924
TCGA-LP-A5U2,14.117268,16.658474,11.187554
TCGA-EA-A44S,13.59648,18.2857,13.642913
TCGA-VS-A8Q9,13.44956,18.015669,11.369445
TCGA-VS-A959,14.042738,15.948097,12.51659
TCGA-HG-A2PA,13.617305,16.37926,13.464008
TCGA-EA-A5FO,12.77124,16.761314,12.034395
TCGA-HM-A3JK,13.032869,15.518308,12.984487
TCGA-DS-A0VN,14.673408,18.127808,12.63634
TCGA-DS-A1OC,13.752846,17.230385,12.509022
TCGA-MA-AA3Y,12.931534,18.570047,10.595365
TCGA-EA-A5ZE,13.854271,17.168102,11.22666
TCGA-C5-A1BE,12.76292,17.20923,12.451562
TCGA-EA-A5O9,14.102448,17.989119,12.4875965
TCGA-EA-A3HR,13.293762,16.653568,13.205457
TCGA-EA-A5ZD,14.24571,17.297487,13.454999
TCGA-C5-A7UE,13.628021,18.335276,12.589789
TCGA-FU-A770,14.549035,13.593021,7.589493
TCGA-ZJ-AAX4,13.81931,17.806902,13.816728
TCGA-JW-A852,14.504579,18.21667,11.677449
TCGA-C5-A2LY,14.80931,17.695038,11.443318
TCGA-VS-A9U7,14.56957,18.002043,11.845433
TCGA-C5-A7UI,14.749968,18.053242,11.649577
TCGA-DG-A2KK,14.968135,13.765244,7.664244
TCGA-DS-A0VM,13.762006,16.984781,12.232792
TCGA-C5-A7X5,12.610221,18.010817,12.812825
TCGA-C5-A1MP,13.788114,17.097033,13.867402
TCGA-VS-AA62,13.06789,18.337051,9.998175
TCGA-JX-A3Q0,14.548498,17.496346,12.781406
TCGA-VS-A8EJ,14.592201,14.334679,8.802276
TCGA-IR-A3LH,13.4144,17.918781,10.2895
TCGA-DG-A2KL,13.097805,16.538998,13.595493
TCGA-FU-A3YQ,14.089222,16.82974,13.630473
TCGA-EA-A3HT,13.215209,16.602291,13.526602
TCGA-FU-A23K,14.655514,17.02279,10.709805
TCGA-EX-A1H5,12.935756,16.945353,12.190365
TCGA-FU-A3NI,13.404105,17.926056,13.633349
TCGA-VS-A8EC,12.191612,17.118887,12.686136
TCGA-DS-A1OD,14.701353,16.681698,11.531541
TCGA-UC-A7PD,13.012679,18.757326,10.818462
TCGA-FU-A3HZ,13.974824,14.751296,9.089836
TCGA-DS-A7WH,14.187949,13.477012,7.519275
TCGA-EK-A2RJ,13.202573,18.097488,9.759489
TCGA-IR-A3LB,14.0926075,13.665001,7.7922854
TCGA-C5-A2LT,12.747771,18.630327,10.152513
TCGA-C5-A7XC,13.88497,16.177666,13.293321
TCGA-C5-A7CK,12.309755,17.08572,13.019172
TCGA-VS-A957,13.273463,17.163101,12.225904
TCGA-VS-A9UP,14.26169,14.990049,9.634665
TCGA-UC-A7PG,14.007955,17.978111,13.470725
TCGA-VS-A8EH,12.696126,17.439526,12.767282
TCGA-DR-A0ZM,14.779262,17.653482,12.298875
TCGA-C5-A8YQ,13.344979,18.251795,13.663177
TCGA-MA-AA3X,14.074856,17.95912,13.581053
TCGA-GH-A9DA,12.886349,18.734137,10.359554
TCGA-MY-A5BD,14.872022,13.661443,7.477741
TCGA-VS-A9UM,13.702264,17.535303,13.878639
TCGA-EK-A3GK,14.85,13.704885,7.9129105
TCGA-EK-A2RB,13.649463,18.42849,13.437507
TCGA-EA-A1QS,13.072117,15.61669,12.97047
TCGA-C5-A1M7,13.733456,17.417877,13.198269
TCGA-Q1-A73S,13.905702,15.365377,9.915669
TCGA-IR-A3LL,14.80093,17.76855,12.021466
TCGA-C5-A1BM,14.01681,17.191042,13.771687
TCGA-C5-A1M6,14.116527,14.975934,9.537766
TCGA-R2-A69V,14.765798,17.549446,11.513936
TCGA-EA-A3QE,14.17001,16.989971,13.648088
TCGA-VS-A9V4,14.018738,14.021432,7.7251706
TCGA-EK-A2RA,13.909964,17.37404,11.898266
TCGA-EX-A69L,13.866709,17.455305,11.193343
TCGA-EX-A69M,13.894958,17.204374,11.318257
TCGA-DS-A0VK,12.807553,17.309715,12.58709
TCGA-EX-A3L1,12.760469,18.633408,10.193331
TCGA-MY-A5BE,14.818253,16.947853,11.398514
TCGA-EX-A449,14.671906,13.930305,7.4112196
TCGA-LP-A4AV,14.756219,17.976858,11.461685
TCGA-JW-A5VK,14.236138,18.350195,11.854624
TCGA-EK-A2RM,14.224228,15.159877,9.773304
TCGA-C5-A2LX,14.756331,17.022495,11.28208
TCGA-MA-AA41,13.054571,18.350653,13.350458
TCGA-MA-AA43,13.145187,15.958311,13.268963
TCGA-IR-A3L7,12.8657255,16.44679,12.479995
TCGA-JX-A5QV,13.757097,17.194307,12.650683
TCGA-VS-A94W,14.504081,16.678082,11.786648
TCGA-EA-A5ZF,14.226461,15.024599,9.605371
TCGA-FU-A3TQ,13.102743,16.733688,13.558109
TCGA-VS-A8QH,13.940261,13.948505,7.652344
TCGA-IR-A3LK,14.043583,17.436426,12.600888
TCGA-JW-A5VJ,13.3784895,18.312197,13.575641
TCGA-BI-A0VR,13.96794,17.022367,12.532738
TCGA-C5-A1M5,13.522743,16.709476,12.296817
TCGA-IR-A3LI,14.631425,13.674743,7.047459
TCGA-DS-A7WI,13.414027,18.745615,10.547548
TCGA-C5-A8ZZ,12.195406,16.906025,12.854054
TCGA-EA-A50E,13.03058,17.328651,13.421589
TCGA-MY-A5BF,14.072874,17.826395,12.576395
TCGA-EK-A3GJ,14.143568,18.042782,12.400503
TCGA-EK-A2H1,13.069388,18.848114,10.118443
TCGA-C5-A2M2,14.333321,13.776361,7.1058044
TCGA-BI-A20A,13.882264,16.380228,11.957741
TCGA-C5-A3HL,12.840645,16.884466,12.647453
TCGA-C5-A1BQ,14.534598,17.149446,12.587716
TCGA-C5-A1BF,13.148408,18.305481,9.92902
TCGA-EX-A1H6,14.32427,13.532188,7.642259
TCGA-JX-A3PZ,13.312919,18.715963,9.955079
TCGA-DS-A7WF,14.098544,14.686509,9.3337345
TCGA-EK-A2IR,12.148539,17.214117,12.757615
TCGA-VS-A9V1,14.005973,14.246331,7.4550977
TCGA-C5-A8YR,13.324891,18.345451,9.695297
TCGA-JW-A5VI,13.190002,17.544708,13.249561
TCGA-EA-A4BA,14.323598,14.104511,8.616782
TCGA-FU-A3TX,14.428882,16.577356,11.771426
TCGA-PN-A8MA,14.390832,14.957407,9.503731
TCGA-VS-A9UZ,14.539935,13.857744,7.4833336
TCGA-VS-A9UD,14.829171,17.423794,11.374551
TCGA-VS-A94X,13.123469,18.292126,9.899779
TCGA-MA-AA42,14.804312,17.076733,11.622381
TCGA-VS-A9V5,14.172399,13.800254,7.4413004
TCGA-EA-A439,14.219455,14.85784,9.449256
TCGA-VS-A954,13.295277,17.990515,13.28955
TCGA-FU-A40J,14.472655,13.678922,7.636835
TCGA-EK-A2H0,13.356058,18.473022,11.419256
TCGA-EA-A3HQ,14.036166,17.13699,13.281467
TCGA-EK-A2GZ,13.0025015,17.142,12.92688
TCGA-DS-A1O9,13.493571,16.681114,13.59292
TCGA-EA-A410,13.998567,14.619369,8.950166
TCGA-FU-A5XV,12.7527685,18.064392,12.163386
TCGA-C5-A8XI,13.166444,16.622643,12.132886
TCGA-EK-A2R7,14.435135,14.9079,9.206251
TCGA-EK-A3GN,13.064501,18.19307,11.608607
TCGA-LP-A7HU,14.347468,16.476702,10.841624
TCGA-C5-A7CJ,13.690352,16.807962,13.66972
TCGA-VS-A9UT,14.360292,14.254192,9.170493
TCGA-C5-A3HE,13.8334255,14.589734,7.9513516
TCGA-VS-A9UL,14.025641,14.873925,9.548369
TCGA-EA-A411,13.414534,15.865168,12.590336
TCGA-EX-A8YF,13.971972,14.601688,7.7911835
TCGA-EA-A556,14.288696,14.241514,8.891841
TCGA-EK-A2RN,14.265005,17.9037,13.356594
TCGA-C5-A7X8,14.047473,13.94276,8.117514
TCGA-JX-A3Q8,14.84883,14.001725,7.560839
TCGA-UC-A7PF,14.309151,16.635145,12.496209
TCGA-C5-A0TN,12.893534,18.827623,10.225123
TCGA-EA-A97N,12.771113,16.647495,13.225363
TCGA-UC-A7PI,14.2406025,13.952057,7.1826434
TCGA-C5-A7CL,13.01416,17.170307,13.486601
TCGA-C5-A7CM,13.912346,14.4995365,7.8020782
TCGA-MY-A913,13.026934,18.589916,10.261002
TCGA-EK-A2PI,12.258477,17.230556,12.802425
TCGA-C5-A8YT,14.161866,14.112151,8.865867
TCGA-Q1-A6DV,14.882535,13.695636,7.4417634
TCGA-VS-A9UO,14.108792,14.079816,7.301318
TCGA-ZJ-AAXD,12.700576,16.488636,12.978518
TCGA-VS-A94Z,14.418496,16.80301,12.518776
TCGA-C5-A1BL,13.653281,17.505669,12.827117
TCGA-Q1-A5R1,14.634239,13.708884,7.3883348
TCGA-ZJ-AAXU,14.256548,18.11875,12.111356
TCGA-LP-A4AU,13.923103,16.23018,13.369887
TCGA-MU-A51Y,14.173062,16.58232,13.411593
TCGA-FU-A57G,14.200928,14.069878,8.740925
TCGA-ZJ-AAXB,14.201514,15.442146,9.949511
TCGA-EA-A78R,14.406152,18.09737,11.716224
TCGA-DG-A2KM,14.495124,16.681786,13.266651
TCGA-BI-A0VS,12.683416,17.197624,13.223317
TCGA-IR-A3LC,13.631646,17.607016,11.599786
TCGA-HM-A4S6,14.43621,17.39101,13.3051
TCGA-IR-A3LA,14.699026,14.110266,8.064636
TCGA-ZX-AA5X,13.348657,15.920182,13.195754
TCGA-FU-A3WB,12.805333,16.803082,12.0251665
TCGA-C5-A1MK,13.427378,16.602623,13.727665
TCGA-EA-A43B,13.413069,18.73545,10.397636
TCGA-EK-A2PK,13.384326,17.918879,9.492083
TCGA-VS-A952,14.312454,13.82393,7.140194
TCGA-JW-A5VL,14.462358,17.709719,12.828016
TCGA-EK-A2RC,13.923973,16.697052,13.560493
TCGA-MA-AA3W,14.233241,16.764475,11.869774
TCGA-C5-A2M1,14.659696,14.024381,7.773334
TCGA-DS-A3LQ,12.1584,16.959375,12.888465
TCGA-EK-A2RE,12.65582,18.441448,12.039792
TCGA-VS-A9V3,13.881963,16.785313,12.997719`;

    const metadataCSV = `ID,stage,grade,PT_resistant
TCGA-EA-A3HU,II,G2,NA
TCGA-DS-A1OB,I,G2,Yes
TCGA-C5-A7UH,III,G3,No
TCGA-HM-A6W2,IV,G3,NA
TCGA-VS-A8EK,IV,G2,No
TCGA-FU-A3EO,II,G2,NA
TCGA-LP-A5U3,I,G3,NA
TCGA-ZJ-AAXF,II,G3,NA
TCGA-DR-A0ZL,I,G3,NA
TCGA-VS-A958,II,G2,No
TCGA-EK-A3GM,II,G2,NA
TCGA-C5-A1MF,I,G2,NA
TCGA-JW-A5VH,IV,G2,Yes
TCGA-MU-A5YI,I,G2,NA
TCGA-ZJ-AAXI,II,G2,NA
TCGA-C5-A1BI,III,G2,NA
TCGA-C5-A1BJ,II,G2,NA
TCGA-EA-A3Y4,I,G3,NA
TCGA-C5-A1BK,I,G2,NA
TCGA-EK-A2PM,II,G3,NA
TCGA-ZJ-AAXA,I,G2,NA
TCGA-ZJ-AAX8,III,G2,NA
TCGA-VS-A9U5,II,G3,No
TCGA-2W-A8YY,I,G3,No
TCGA-MU-A8JM,I,G2,NA
TCGA-VS-A8QF,II,G2,No
TCGA-EK-A2R9,I,G3,NA
TCGA-C5-A1BN,I,G3,Yes
TCGA-LP-A4AW,I,G1,NA
TCGA-VS-A9UC,II,G2,Yes
TCGA-EA-A6QX,III,G3,NA
TCGA-C5-A2LS,I,G1,NA
TCGA-HM-A3JJ,I,G3,Yes
TCGA-C5-A1MJ,I,G2,NA
TCGA-C5-A1MI,I,G2,Yes
TCGA-C5-A1MH,III,G3,Yes
TCGA-C5-A2LV,I,G3,NA
TCGA-EK-A2R8,I,G3,NA
TCGA-VS-A9UU,II,G1,NA
TCGA-C5-A1M8,I,G2,NA
TCGA-FU-A3HY,I,G2,No
TCGA-C5-A1ML,I,G3,NA
TCGA-C5-A2LZ,III,G2,NA
TCGA-C5-A7CH,II,G2,NA
TCGA-IR-A3LF,I,G2,NA
TCGA-C5-A7UC,I,G3,NA
TCGA-VS-A8Q8,I,G2,NA
TCGA-4J-AA1J,I,G3,NA
TCGA-C5-A7CG,I,G2,NA
TCGA-VS-A9UB,II,G3,No
TCGA-DS-A1OA,I,G3,Yes
TCGA-VS-A9UQ,I,G2,NA
TCGA-VS-A950,III,G3,NA
TCGA-C5-A902,I,G3,NA
TCGA-FU-A23L,II,G3,No
TCGA-EA-A3HS,I,G1,NA
TCGA-C5-A1ME,I,G1,NA
TCGA-C5-A1MQ,II,G2,No
TCGA-EK-A2IP,I,G3,NA
TCGA-VS-A9UY,IV,G2,Yes
TCGA-DG-A2KJ,III,G3,No
TCGA-VS-A9V0,I,G3,No
TCGA-C5-A3HF,I,G2,NA
TCGA-DS-A0VL,I,G2,NA
TCGA-C5-A905,I,G2,NA
TCGA-C5-A3HD,II,G2,No
TCGA-XS-A8TJ,I,G2,NA
TCGA-C5-A7X3,III,G2,NA
TCGA-EK-A2RL,I,G2,NA
TCGA-DS-A5RQ,I,G2,No
TCGA-EK-A2RO,II,G1,NA
TCGA-VS-A8QC,IV,G2,NA
TCGA-C5-A7CO,I,G2,No
TCGA-EA-A3QD,III,G3,No
TCGA-C5-A1M9,I,G3,Yes
TCGA-JW-A5VG,II,G3,No
TCGA-EK-A2RK,I,G3,NA
TCGA-VS-A8EL,II,G3,No
TCGA-FU-A2QG,I,G2,NA
TCGA-C5-A1MN,III,G2,NA
TCGA-Q1-A73P,I,G1,NA
TCGA-VS-A9V2,I,G2,NA
TCGA-JW-AAVH,I,G2,NA
TCGA-C5-A907,I,G2,No
TCGA-LP-A4AX,I,G3,NA
TCGA-ZJ-AAXT,III,G2,NA
TCGA-EA-A1QT,I,G2,NA
TCGA-LP-A5U2,III,G3,NA
TCGA-EA-A44S,III,G2,Yes
TCGA-VS-A8Q9,I,G2,NA
TCGA-VS-A959,II,G3,NA
TCGA-HG-A2PA,I,G2,No
TCGA-EA-A5FO,I,G2,NA
TCGA-HM-A3JK,II,G3,No
TCGA-DS-A0VN,I,G2,No
TCGA-DS-A1OC,I,G2,No
TCGA-MA-AA3Y,I,G3,NA
TCGA-EA-A5ZE,I,G3,NA
TCGA-C5-A1BE,I,G2,Yes
TCGA-EA-A5O9,I,G2,NA
TCGA-EA-A3HR,II,G2,NA
TCGA-EA-A5ZD,I,G2,NA
TCGA-C5-A7UE,I,G2,No
TCGA-FU-A770,III,G2,NA
TCGA-ZJ-AAX4,II,G3,NA
TCGA-JW-A852,II,G2,NA
TCGA-C5-A2LY,I,G2,No
TCGA-VS-A9U7,I,G3,No
TCGA-C5-A7UI,I,G3,NA
TCGA-DG-A2KK,III,G3,NA
TCGA-DS-A0VM,I,G3,No
TCGA-C5-A7X5,IV,G3,NA
TCGA-C5-A1MP,I,G3,NA
TCGA-VS-AA62,II,G2,Yes
TCGA-JX-A3Q0,III,G2,NA
TCGA-VS-A8EJ,II,G3,Yes
TCGA-IR-A3LH,II,G4,NA
TCGA-DG-A2KL,II,G1,NA
TCGA-FU-A3YQ,I,G1,NA
TCGA-EA-A3HT,I,G1,NA
TCGA-FU-A23K,III,G3,NA
TCGA-EX-A1H5,II,G3,NA
TCGA-FU-A3NI,I,G2,NA
TCGA-VS-A8EC,III,G2,No
TCGA-DS-A1OD,I,G3,No
TCGA-UC-A7PD,I,G2,NA
TCGA-FU-A3HZ,II,G3,No
TCGA-DS-A7WH,I,G2,No
TCGA-EK-A2RJ,I,G3,NA
TCGA-IR-A3LB,I,G3,NA
TCGA-C5-A2LT,I,G3,No
TCGA-C5-A7XC,I,G2,NA
TCGA-C5-A7CK,IV,G2,NA
TCGA-VS-A957,I,G3,No
TCGA-VS-A9UP,II,G3,No
TCGA-UC-A7PG,III,G1,NA
TCGA-VS-A8EH,III,G2,No
TCGA-DR-A0ZM,III,G2,No
TCGA-C5-A8YQ,I,G2,Yes
TCGA-MA-AA3X,III,G2,No
TCGA-GH-A9DA,I,G3,NA
TCGA-MY-A5BD,II,G1,NA
TCGA-VS-A9UM,IV,G2,No
TCGA-EK-A3GK,I,G3,NA
TCGA-EK-A2RB,IV,G3,NA
TCGA-EA-A1QS,I,G2,NA
TCGA-C5-A1M7,I,G2,NA
TCGA-Q1-A73S,I,G2,No
TCGA-IR-A3LL,I,G2,No
TCGA-C5-A1BM,I,G2,NA
TCGA-C5-A1M6,II,G3,Yes
TCGA-R2-A69V,I,G3,NA
TCGA-EA-A3QE,I,G2,NA
TCGA-VS-A9V4,IV,G2,NA
TCGA-EK-A2RA,II,G3,NA
TCGA-EX-A69L,I,G3,NA
TCGA-EX-A69M,I,G3,NA
TCGA-DS-A0VK,I,G3,Yes
TCGA-EX-A3L1,II,G3,No
TCGA-MY-A5BE,I,G3,NA
TCGA-EX-A449,IV,G1,NA
TCGA-LP-A4AV,I,G2,NA
TCGA-JW-A5VK,I,G3,NA
TCGA-EK-A2RM,I,G3,NA
TCGA-C5-A2LX,I,G2,No
TCGA-MA-AA41,II,G2,NA
TCGA-MA-AA43,III,G3,NA
TCGA-IR-A3L7,I,G3,No
TCGA-JX-A5QV,I,G3,NA
TCGA-VS-A94W,II,G2,No
TCGA-EA-A5ZF,I,G2,NA
TCGA-FU-A3TQ,III,G2,NA
TCGA-VS-A8QH,I,G2,NA
TCGA-IR-A3LK,I,G3,NA
TCGA-JW-A5VJ,II,G3,NA
TCGA-BI-A0VR,III,G3,NA
TCGA-C5-A1M5,I,G2,NA
TCGA-IR-A3LI,IV,G2,No
TCGA-DS-A7WI,II,G2,No
TCGA-C5-A8ZZ,II,G2,NA
TCGA-EA-A50E,IV,G2,NA
TCGA-MY-A5BF,II,G1,NA
TCGA-EK-A3GJ,I,G3,NA
TCGA-EK-A2H1,I,G3,NA
TCGA-C5-A2M2,I,G2,NA
TCGA-BI-A20A,I,G3,NA
TCGA-C5-A3HL,I,G2,NA
TCGA-C5-A1BQ,III,G2,No
TCGA-C5-A1BF,I,G1,NA
TCGA-EX-A1H6,I,G1,NA
TCGA-JX-A3PZ,I,G2,NA
TCGA-DS-A7WF,I,G3,No
TCGA-EK-A2IR,I,G3,NA
TCGA-VS-A9V1,IV,G2,Yes
TCGA-C5-A8YR,I,G3,NA
TCGA-JW-A5VI,II,G3,NA
TCGA-EA-A4BA,I,G2,No
TCGA-FU-A3TX,I,G3,NA
TCGA-PN-A8MA,II,G3,NA
TCGA-VS-A9UZ,I,G2,NA
TCGA-VS-A9UD,III,G2,No
TCGA-VS-A94X,II,G2,No
TCGA-MA-AA42,II,G3,NA
TCGA-VS-A9V5,II,G2,Yes
TCGA-EA-A439,II,G3,NA
TCGA-VS-A954,III,G2,No
TCGA-FU-A40J,III,G3,No
TCGA-EK-A2H0,II,G3,No
TCGA-EA-A3HQ,II,G2,NA
TCGA-EK-A2GZ,III,G2,NA
TCGA-DS-A1O9,IV,G3,NA
TCGA-EA-A410,II,G2,NA
TCGA-FU-A5XV,III,G3,NA
TCGA-C5-A8XI,I,G3,NA
TCGA-EK-A2R7,I,G3,NA
TCGA-EK-A3GN,III,G3,NA
TCGA-LP-A7HU,II,G3,NA
TCGA-C5-A7CJ,II,G2,NA
TCGA-VS-A9UT,I,G3,NA
TCGA-C5-A3HE,I,G3,NA
TCGA-VS-A9UL,III,G3,NA
TCGA-EA-A411,I,G2,NA
TCGA-EX-A8YF,I,G3,NA
TCGA-EA-A556,I,G3,NA
TCGA-EK-A2RN,I,G2,NA
TCGA-C5-A7X8,I,G2,NA
TCGA-JX-A3Q8,I,G3,NA
TCGA-UC-A7PF,I,G2,NA
TCGA-C5-A0TN,I,G3,Yes
TCGA-EA-A97N,I,G2,NA
TCGA-UC-A7PI,I,G1,NA
TCGA-C5-A7CL,III,G2,Yes
TCGA-C5-A7CM,I,G2,No
TCGA-MY-A913,II,G3,No
TCGA-EK-A2PI,III,G2,NA
TCGA-C5-A8YT,I,G3,Yes
TCGA-Q1-A6DV,I,G2,NA
TCGA-VS-A9UO,II,G2,No
TCGA-ZJ-AAXD,III,G2,NA
TCGA-VS-A94Z,II,G2,No
TCGA-C5-A1BL,I,G2,NA
TCGA-Q1-A5R1,I,G2,NA
TCGA-ZJ-AAXU,II,G2,NA
TCGA-LP-A4AU,III,G3,No
TCGA-MU-A51Y,II,G2,NA
TCGA-FU-A57G,I,G2,NA
TCGA-ZJ-AAXB,I,G3,NA
TCGA-EA-A78R,I,G2,NA
TCGA-DG-A2KM,I,G2,No
TCGA-BI-A0VS,I,G3,NA
TCGA-IR-A3LC,I,G3,No
TCGA-HM-A4S6,III,G3,No
TCGA-IR-A3LA,I,G3,No
TCGA-ZX-AA5X,III,G2,NA
TCGA-FU-A3WB,II,G2,No
TCGA-C5-A1MK,III,G3,Yes
TCGA-EA-A43B,I,G2,No
TCGA-EK-A2PK,I,G3,NA
TCGA-VS-A952,I,G2,NA
TCGA-JW-A5VL,I,G1,NA
TCGA-EK-A2RC,I,G3,NA
TCGA-MA-AA3W,I,G3,No
TCGA-C5-A2M1,I,G2,NA
TCGA-DS-A3LQ,III,G3,No
TCGA-EK-A2RE,II,G2,NA
TCGA-VS-A9V3,IV,G3,NA`;

    async function generatePlotHTML() {
      // Parse CSV data
      const dataPoints = parseDataCSV(dataCSV);
      const [pointMetadata, datasetMetadata] = parseMetadataCSV(metadataCSV);

      // Determine point IDs
      const pointIDs = dataPoints.map(point => point.ID);

      // Create color options
      const colorSelect = document.getElementById('color-select');
      pointMetadata.forEach((meta, i) => {
        const option = document.createElement('option');
        option.value = i.toString();
        option.textContent = meta.name;
        colorSelect.appendChild(option);
      });

      const colorLegend = document.getElementById('color-legend');

      colorSelect.addEventListener('change', function() {
        currentColorIndex = parseInt(this.value);
        if (currentColorIndex === -1) {
          scatterGL.setPointColorer(null);
          colorLegend.style.display = 'none';
        } else {
          scatterGL.setPointColorer(createPointColorer(currentColorIndex));
          updateColorLegend(currentColorIndex);
        }
      });

      function createPointColorer(colorIndex) {
        return function(i, selectedIndices, hoverIndex) {
          var labelIndex = datasetMetadata[i][colorIndex];
          var opaque = false;
          if (opaque) {
            return opaqueColorsByLabel[labelIndex];
          } else {
            if (hoverIndex === i) {
              return "red";
            }
            // If nothing is selected, return the heavy color
            if (selectedIndices.size === 0) {
              return heavyTransparentColorsByLabel[labelIndex];
            }
            // Otherwise, keep the selected points heavy and non-selected light
            else {
              var isSelected = selectedIndices.has(i);
              return isSelected
                ? heavyTransparentColorsByLabel[labelIndex]
                : lightTransparentColorsByLabel[labelIndex];
            }
          }
        };
      }

      function updateColorLegend(colorIndex) {
        const meta = pointMetadata[colorIndex];
        colorLegend.innerHTML = `<h5>${meta.name}</h5>`;

        // Sort the values alphabetically
        const sortedValues = [...meta.values].sort((a, b) => a.localeCompare(b));

        sortedValues.forEach((value) => {
          const index = meta.values.indexOf(value);
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `
            <div class="legend-color" style="background-color: ${heavyTransparentColorsByLabel[index]}"></div>
            <div>${value}</div>
          `;
          colorLegend.appendChild(legendItem);
        });
        colorLegend.style.display = 'block';
      }

      const pointInfoTip = "Select a point for info";
      let clickedPointMetadata = null;
      let currentColorIndex = -1;

      function getPointMetadata(i) {
        var metadata = {};
        for (var j = 0; j < pointMetadata.length; j++) {
          let propertyName = pointMetadata[j].name;
          let propertyValue = pointMetadata[j].values[datasetMetadata[i][j]];
          metadata[propertyName] = propertyValue;
        }
        var metadata_str = Object.entries(metadata)
          .map(([key, value]) => `${key}: ${value}`)
          .join('\n');
        return `ID: ${pointIDs[i]}\n${metadata_str}`;
      }

      const dataset = new ScatterGL.Dataset(dataPoints.map(point => [point.x, point.y, point.z]), datasetMetadata);
      const scatterGL = new ScatterGL(document.getElementById("container"), {
        onClick: function(point) {
          if (point === null) {
            clickedPointMetadata = null;
            setMessage(pointInfoTip);
          } else {
            pointClicked = true;
            clickedPointMetadata = getPointMetadata(parseInt(point));
            setMessage(`Clicked point ${clickedPointMetadata}`);
          }
        },
        onHover: function(point) {
          if (point === null) {
            if (clickedPointMetadata === null) {
              setMessage(pointInfoTip);
            } else {
              setMessage(`Clicked point ${clickedPointMetadata}`);
            }
          } else {
            setMessage(`Hovered point ${getPointMetadata(parseInt(point))}`);
          }
        },
        onSelect: function(points) {
          var message = "";
          if (points.length === 0) {
            message = "no selection";
          } else if (points.length === 1) {
            message = "selected " + points;
          } else {
            message = "selected " + points.length + " points";
          }
          setMessage(message);
        },
        renderMode: "POINT",
        orbitControls: {
          zoomSpeed: 1.125,
        },
      });
      scatterGL.render(dataset);

      window.addEventListener("resize", function() {
        scatterGL.resize();
      });

      document.querySelectorAll('input[name="interactions"]').forEach(function(inputElement) {
        inputElement.addEventListener("change", function() {
          if (inputElement.value === "pan") {
            scatterGL.setPanMode();
          } else if (inputElement.value === "select") {
            scatterGL.setSelectMode();
          }
        });
      });

      var hues = [...Array(10)].map((_, i) => Math.floor((255 / 10) * i));
      var lightTransparentColorsByLabel = hues.map(
        hue => `hsla(${hue}, 100%, 50%, 0.05)`
      );
      var heavyTransparentColorsByLabel = hues.map(
        hue => `hsla(${hue}, 100%, 50%, 0.75)`
      );
      var opaqueColorsByLabel = hues.map(hue => `hsla(${hue}, 100%, 60%, 1)`);

      document.querySelectorAll('input[name="color"]').forEach(function(inputElement) {
        inputElement.addEventListener("change", function() {
          currentColorIndex = parseInt(inputElement.value);
          if (currentColorIndex === -1) {
            scatterGL.setPointColorer(null);
          } else {
            scatterGL.setPointColorer(function(i, selectedIndices, hoverIndex) {
              var labelIndex = datasetMetadata[i][currentColorIndex];
              var opaque = false;
              if (opaque) {
                return opaqueColorsByLabel[labelIndex];
              } else {
                if (hoverIndex === i) {
                  return "red";
                }
                // If nothing is selected, return the heavy color
                if (selectedIndices.size === 0) {
                  return heavyTransparentColorsByLabel[labelIndex];
                }
                // Otherwise, keep the selected points heavy and non-selected light
                else {
                  var isSelected = selectedIndices.has(i);
                  return isSelected
                    ? heavyTransparentColorsByLabel[labelIndex]
                    : lightTransparentColorsByLabel[labelIndex];
                }
              }
            });
          }
        });
      });

      const toggleOrbitButton = document.getElementById('toggle-orbit');
      toggleOrbitButton.addEventListener('click', () => {
        if (scatterGL.isOrbiting()) {
          scatterGL.stopOrbitAnimation();
        } else {
          scatterGL.startOrbitAnimation();
        }
      });

      function setMessage(message) {
        console.log(message);
        document.getElementById("messages").innerHTML = message;
      }
      setMessage(pointInfoTip);
    }

    function parseDataCSV(csv) {
      const rows = csv.trim().split('\n');
      const headers = rows[0].split(',');

      return rows.slice(1).map(row => {
        const values = row.split(',');
        const point = {};
        headers.forEach((header, index) => {
          point[header] = header === 'ID' ? values[index] : parseFloat(values[index]);
        });
        return point;
      });
    }

    function parseMetadataCSV(csv) {
      const rows = csv.trim().split('\n');
      const headers = rows[0].split(',');

      const metadataByID = {};
      rows.slice(1).forEach(row => {
        const values = row.split(',');
        metadataByID[values[0]] = {};
        headers.slice(1).forEach((header, index) => {
          metadataByID[values[0]][header] = values[index + 1];
        });
      });

      const pointMetadata = headers.slice(1).map(header => ({
        name: header,
        values: [...new Set(Object.values(metadataByID).map(item => item[header]))]
      }));

      const metadataLookup = pointMetadata.reduce((acc, meta) => {
          acc[meta.name] = meta.values.reduce((acc2, value, i) => {
              acc2[value] = i;
              return acc2;
          }, {});
          return acc;
      }, {});

      const datasetMetadata = Object.values(metadataByID).map(meta => {
        return pointMetadata.map(prop => metadataLookup[prop.name][meta[prop.name]]);
      });

      return [pointMetadata, datasetMetadata];
    }

    generatePlotHTML();
  </script>
</body>
</html>
